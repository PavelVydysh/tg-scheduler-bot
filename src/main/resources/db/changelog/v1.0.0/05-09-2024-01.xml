<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.6.xsd">

    <changeSet id="05-09-2024-01" author="p.vydysh">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="poll"/>
            </not>
        </preConditions>

        <sql>
            CREATE TABLE poll(
                id INT PRIMARY KEY,
                created_date DATE NOT NULL,
                version INT NOT NULL
            );
        </sql>
    </changeSet>

    <changeSet id="05-09-2024-02" author="p.vydysh">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="user"/>
            </not>
        </preConditions>

        <sql>
            CREATE TABLE t_user(
                id INT PRIMARY KEY,
                first_name TEXT,
                last_name TEXT,
                username TEXT
            );
        </sql>
    </changeSet>

    <changeSet id="05-09-2024-03" author="p.vydysh">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="answer_type"/>
            </not>
        </preConditions>

        <sql>
            CREATE TABLE answer_type(
                id UUID PRIMARY KEY,
                position INT NOT NULL,
                title TEXT NOT NULL
            );
        </sql>
    </changeSet>

    <changeSet id="05-09-2024-04" author="p.vydysh">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="answer"/>
            </not>
        </preConditions>

        <sql>
            CREATE TABLE answer(
                id UUID PRIMARY KEY,
                poll_id INT REFERENCES poll (id),
                user_id INT REFERENCES t_user (id),
                answer_type_id UUID REFERENCES answer_type (id)
            );
        </sql>
    </changeSet>

    <changeSet id="05-09-2024-05" author="p.vydysh">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="poll_version_answer_type"/>
            </not>
        </preConditions>

        <sql>
            CREATE TABLE poll_version_answer_type(
                id UUID PRIMARY KEY,
                answer_type_id UUID REFERENCES answer_type (id),
                version INT NOT NULL
            );
        </sql>
    </changeSet>

    <changeSet id="05-09-2024-06" author="p.vydysh">
        <preConditions>
            <tableExists tableName="answer_type"/>
        </preConditions>

        <sql>
            INSERT INTO answer_type VALUES
                (gen_random_uuid(), 0, 'Я'),
                (gen_random_uuid(), 1, 'Опоздаю'),
                (gen_random_uuid(), 2, 'Я лох');
        </sql>
    </changeSet>

    <changeSet id="05-09-2024-07" author="p.vydysh">
        <preConditions>
            <tableExists tableName="poll_version_answer_type"/>
        </preConditions>

        <sql>
            INSERT INTO poll_version_answer_type (id, answer_type_id, version)
                SELECT gen_random_uuid(), answer_type.id, 1
                FROM answer_type;
        </sql>
    </changeSet>

</databaseChangeLog>